<!DOCTYPE html>
<html>
  <head>
    <title>System Application Runtime: Execution and Security Model</title>
    <meta http-equiv='Content-Type' content='text/html;charset=utf-8' />
    <script src='http://www.w3.org/Tools/respec/respec-w3c-common' class='remove' async></script>
    <script class='remove'>
      var respecConfig = {
          // document info
          specStatus:           "ED",
          shortName:            "sysapps-runtime",
          // publishDate:   "",
          previousMaturity: "",
          previousPublishDate:  "",
          previousURI : "",
          copyrightStart:       "2013",
          edDraftURI:           "http://sysapps.github.com/sysapps/proposals/Sysapps-Runtime/Overview.html",
          // lcEnd:  "2010-08-06",
          // extraCSS:             ["../css/respec.css"],
          extraCSS:             ["http://dev.w3.org/2009/dap/ReSpec.js/css/respec.css"],

          // editors
          editors:  [
              { name: "金明(Ming Jin)", url: "",
                company: "Samsung Electronics, Co., Ltd", companyURL: "http://www.samsung.com/sec" },
              { name: "Mounir Lamouri", url: "",
                company: "Mozilla", companyURL: "http://www.mozilla.org" },
              { name: "Janusz Majnert", url: "",
                company: "Samsung Electronics, Co., Ltd", companyURL: "http://www.samsung.com/sec" },
              { name: "송정기(Jungkee Song)", url: "",
                company: "Samsung Electronics, Co., Ltd", companyURL: "http://www.samsung.com/sec" },
          ],
          
          // WG
          wg:           "System Applications WG",
          wgURI:        "http://www.w3.org/2012/sysapps/",
          wgPublicList: "public-sysapps",
          wgPatentURI:  "",
      };
    </script>
  </head>
  <body>
    <section id='abstract'>
      The execution and security model defines the runtime environment, as well as associated APIs, in which installable web applications are securely executed. This specification particularly describes how the execution and security model differs from the traditional browser-based execution and security model.
    </section>
    <section id='sotd'>
      <p>
        This paragraph is here to demonstrate that it is possible to add a completely custom
        piece of HTML inside the SotD.
      </p>
    </section>
    <section class='informative'>
      <h2>Introduction</h2>
      <p>
        Unlike traditional websites, web applications are installable on the device and executed in a runtime environment as a standalone application without any traditional Browser UI chrome. While the Browser-based behavior is well established for normal websites throughout the past decades, little is done for web applications. 
      </p>
      <p>
        This proposal defines the core requirements of the installable web application runtime environment with the focus on management, execution, and security model. 
      </p>
    </section>    

    <section>
      <h2>Terminology</h2>
      <p>
        A <dfn id='system-application'>system application</dfn> is an installable web application that is implemented using 
        web technologies like (but not limited to) HTML, JavaScript, CSS and can access to the set 
        of system and service APIs with certain privileges granted by the runtime environment.
      </p>
      <div class='issue'>
        Can the term "system application" normatively represent the installable web application 
        distinguished from normal "web application" used in W3C specification context? This proposal 
        tried to so since it should be the reason why the WG has been named on the term.
      </div>
      <p>
        A <dfn id='runtime'>runtime</dfn> is a management and execution environment for system applications.
      </p>
      <p>
        An <dfn id='application-service'>application service</dfn> is an "Android intent" like service that provides inter-app invokation and communication mechanism.
      </p>
      <div class='note'>
        At the time of this proposal, <a href='http://dvcs.w3.org/hg/web-intents/raw-file/tip/spec/Overview.html'>Web Intents</a> [[!WEBINTENTS]] and <a href='https://wiki.mozilla.org/WebAPI/WebActivities'>Web Activities</a> are still work in progress. Hence, this proposal specifies <a href='#application=service'>application service</a> to cover inter-app communication capability.
      </div>
      <p>
        The <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers">
        EventHandler</a></dfn> interface represents a callback used for event
        handlers as defined in [[!HTML5]].
      </p>
      <!--
      <p>
        The concepts <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#queue-a-task">
        queue a task</a></dfn> and
        <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#fire-a-simple-event">
        fire a simple event</a></dfn> are defined in [[!HTML5]].
      </p>
      -->
      <p>The concept of <dfn><a href='http://dev.w3.org/html5/spec/webappapis.html#fire-a-simple-event'>
      fire a simple event</a></dfn> is defined in [[!HTML5]].
      </p>
      <p>
        The terms <dfn> <a href="http://dev.w3.org/html5/spec/webappapis.html#event-handlers">
        event handlers</a></dfn> and
        <dfn><a href="http://dev.w3.org/html5/spec/webappapis.html#event-handler-event-type">
        event handler event types</a></dfn> are defined in [[!HTML5]].
      </p>
      <p>The <dfn><a href='http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html/#interface-domerror'>
      DOMError</a></dfn> interface represents an error handling object as
      defined in [[!DOM4]].
      </p>
    </section>
    
    <section>
      <h2>System Application Management</h2>
      <section>
        <h2>Manifest</h2>
        <p>An <dfn>application manifest</dfn> is a JSON file describing an
      installable web application. This JSON file consists of a top-level object
      and several properties. The JSON grammar is described in [[!RFC4627]].
        </p>

        <pre class="example highlight">
        {
          "name": "MozillaBall",
          "description": "Exciting Open Web development action!",
          "launch_path": "/",
          "version": "1.0",
          "icons": {
            "16": "/img/icon_16.png",
            "48": "/img/icon_48.png",
            "128": "/img/icon_128.png"
          },
          "developer": {
            "name": "Mozilla",
            "url": "https://mozilla.org/en-US"
          },
          "appcache_path": "/cache.manifest",
          "locales": [
            "es": {
              "description": "¡Acción abierta emocionante del desarrollo del Web!",
              "developer": {
                "url": "https://mozilla.org/es-ES"
              }
            }
          ],
          "default_locale": "en",
          "screen_size": {
            "min_width": "600",
            "min_height": "300"
          },
          "required_features": [
            "touch", "geolocation", "webgl"
          ],
          "permissions": {
            "contacts": {
              "description": "Required for autocompletion in the share screen",
              "access": "read"
            }
          },
          "fullscreen": "true",
          "relNotes": {
            "1.0": "Bugs fixed. New exciting effects. Ready for an official release!"
            "0.5": "First alpha version with still some bugs but already fun!"
          }
        }
        </pre>

        <section>
          <h2>Properties</h2>

          <section>
            <h2>Adding new properties to the manifest</h2>

            <p>Any new specification can add new properties to the <a>application
            manifest</a>. Those specifications MUST describe the new properties,
            the expected values and the expected behaviour. Implementations MUST
            implement the basic properties as describe below but SHOULD only
            implement any extented feature if they are implementing those
            specifications.
            </p>
          </section>

          <section>
            <h2>Basic properties</h2>

            <p>All leaf properties MUST contain a string value unless specified
             otherwise.
            </p>
            <p>The following properties MUST be part of the <a>application
             manifest</a>: <code>name</code> and <code>description</code>.
             In addition, if <code>locales</code> is part of the <a>application
             manifest</a>, <code>default_locale</code> MUST be part of the <a>
             application manifest</a>. The other properties are optional.
            </p>

            <ul class="properties">
              <li><dfn id="propdef-name">name</dfn>: The name of the web application
              in the default locale. The name SHOULD not be longer than 128
              characters.
              </li>

              <li><dfn id="propdef-description">description</dfn>: A short
              description of the web application. The description MUST be in the
              default locale. The description SHOULD not be longer than 1024
              characters.
              </li>

              <li><dfn id="propdef-default_locale">default_locale</dfn>: The
              property's value MUST be the top-level name and description's locale.
              </li>

              <li><dfn id="propdef-launch_path">launch_path</dfn>: The property's
              value MUST be the path within the application's origin that is loaded
              when the application is launched.
              </li>

              <li><dfn id="propdef-icons">icons</dfn>: A map of icon sizes to URIs of
              the icons (which may be absolute, relative or data URIs). Icons MUST be
              square. Paths beginning with "<code>/</code>" are treated as relative
              to the origin of the app.
              </li>

              <li><dfn id="propdef-developer">developer</dfn>: This property describe
              the developer of the application and MUST contain the following
              properties:

                <ul>
                  <li><dfn id="propdef-developer-name">name</dfn>: The value MUST
                  contain the name of the developer.
                  </li>

                  <li><dfn id="propdef-url">url</dfn>: The value MUST contain an URL
                  pointing to the developer's website
                  </li>
                </ul>
              </li>

              <li><dfn id="propdef-locales">locales</dfn>: The property's value MUST
              contain a map of locale specific overrides of strings contained in
              the <a>application manifest</a>. Each locale key is keyed on a
              locale tag [[!RFC4646]], and contains a sparse representation of the
              manifest. Any field in the <a>locales</a> property SHOULD override
              the corresponding property in a localized user interface. The UA
              MAY ignore some values if localizing the property doesn't appear
              to be legit.<br>
              If the <a>locales</a> property is set, the <a>default_locale</a>
              MUST also be set.
              </li>

<!-- Commented because it is a controversial feature.
          <li><dfn id=
          "propdef-installs_allowed_from">installs_allowed_from</dfn>: An array
          of origins that are allowed to trigger installation of this
          application. This field allows the developer to restrict installation
          of their application to specific sites. If the value is omitted,
          installs are allowed from any site.</li>
-->

              <li><dfn id="propdef-appcache_path">appcache_path</dfn>: The value MUST
              contain the absolute path to the application cache manifest
              [[!OFFLINE-WEBAPPS]].<br>
              When an application is installed, the AppCache manifest will be
              fetched and parsed, and its static assets under the CACHE header
              MUST be cached.
              </li>

              <li><dfn id="propdef-version">version</dfn>: The value MUST be a
              string that represents the version of the application. The UA SHOULD
              NOT interpret this value but MAY show it to the user so the auther
              SHOULD use human understandable versions.
              </li>

              <li><dfn id="propdef-screen_size">screen_size</dfn>: This object
              SHOULD contain the <code>min_height</code> and <code>min_width</code>
              properties that describe the minimum height and width (in pixels) the
              application needs in order to render correctly. Those values are only
              hint for the UA and should not be considered as mandatory
              restrictions.
              </li>

              <li><dfn id="propdef-required_features">required_features</dfn>: This
              value MUST be an array containing the mandatory feature set the
              application needs in order to run correctly. If the property is
              missing or the value is an empty array or if the value is invalid, the
              mandatory feature set SHOULD be considered as the empty set.<br>
              <span style='color: red;'>TBD: add a list of features.</span>
              </li>

<!-- Commented because it might hopefully go to the Screen Orientation API spec.
          <li>
            <dfn id="propdef-orientation">orientation</dfn>: This value defines
            the allowed orientations at which the application may be rendered. If
            a value is provided, the runtime MUST ensure that the viewport
            rendering the application will adhere to one of the specified values
            and never orient the application in a direction not specified in this
            property. The default behavior SHOULD be to rotate the viewport at an
            angle that best fits the orientation of the device, and MUST change
            as the user spatially rotates the device. The value MUST be an
            array containing one or more of the following string values
            (duplicates SHOULD be ignored):

            <ul>
              <li><dfn id=
              "propdef-orientation-portrait-primary">portrait-primary</dfn>:
              Locked to a single portrait direction. If the device has an obvious
              primary orientation in portrait mode, this is that orientation. If
              there is no obvious primary orientation due to landscape being the
              primary orientation for the device, this is the orientation if
              rotating the device 90 degrees clock-wise from the primary
              landscape mode.</li>

              <li><dfn id=
              "propdef-orientation-landscape-primary">landscape-primary</dfn>:
              Locked to a single landscape direction. If the device has an
              obvious primary orientation in landscape mode, this is that
              orientation. If there is no obvious landscape orientation due to
              portrait being the primary orientation for the device, this is the
              orientation if rotating the device 90 degrees clock-wise from the
              primary portrait mode.</li>

              <li>
                <dfn id=
                "propdef-orientation-portrait-secondary">portrait-secondary</dfn>:
                The portrait mode opposite of <a>portrait-primary</a>.
              </li>

              <li>
                <dfn id=
                "propdef-orientation-landscape-secondary">landscape-secondary</dfn>:
                The landscape mode opposite of <a>landscape-primary</a>.
              </li>

              <li><dfn id="propdef-orientation-portrait">portrait</dfn>:
              Equivalent to
              <code>["portrait-primary", "portrait-secondary"]</code>.</li>

              <li><dfn id="propdef-orientation-landscape">landscape</dfn>:
              Equivalent to
              <code>["landscape-primary", "landscape-secondary"]</code>.</li>
            </ul>
          </li>
-->

              <li><dfn id="propdef-fullscreen">fullscreen</dfn>: This value MUST be
              set to either <dfn>true</dfn> or <dfn>false</dfn> to describe whether
              the runtime should launch the application in fullscreen mode.
              </li>

              <li><dfn id='propdef-relnotes'>relNotes</dfn>: This property's value
              MUST contain a map associating an application's version with a string
              describing the changes between that version and the previous one.
              </li>

              <li><dfn id="propdef-permisssions">permissions</dfn>: This value
              consists of a set of permissions that the application needs. An
              application SHOULD list every API that is considered to require user
              permission in this field. Usage of an API without a corresponding
              entry in the manifest SHOULD fail. The field is an object, with each
              property name specifying a single permission, and object containing
              the following fields:

                <ul>
                  <li><dfn id="propdef-permissions-desc">description</dfn>: Contains
                  a human readable string specifying the intent behind requesting
                  use of this API. This property is mandatory.
                  </li>
                  <li><dfn id="propdef-permissions-access">access</dfn>: Contains a
                  a string specifying the type of access required for this
                  permission. This field is mandatory for a certain subset of
                  permissions, and MUST be one of <dfn>read</dfn>,
                  <dfn>readwrite</dfn>, <dfn>readcreate</dfn>, or
                  <dfn>createonly</dfn>.
                  </li>
                </ul>

              <p>Each specification MUST specify the new permissions that would be
              required to use the feature it is defining.
              </p>
              </li>

<!-- Commented because it should go to the Web Intents/Web Activities spec.
          <li><dfn id="propdef-activities">activities</dfn>: This value specifies
          a set of
          <a href="https://wiki.mozilla.org/WebAPI/WebActivities">WebActivities</a>
          that this app supports. Each property in this value is a discrete
          activity whose name matches the property name. Activity names are
          free-form text, and each activity is represented by an object. This
          object MUST contain the following property:

          <ul>
            <li><dfn id="propdef-activities-href">href</dfn>: When another app
            or web page initiates an activity that is supported by this app, if
            this app is chosen to perform the activity, this page will be opened
            in the manner specified by the <dfn>disposition</dfn> property. The
            manner in which a particular app is chosen to perform an activity is
            out of scope for this specification.</li>
          </ul>

          An activity object MAY also contain the following properties:

          <ul>
            <li><dfn id="propdef-activites-disposition">disposition</dfn>: This
            value specifies how the page specified in <dfn>href</dfn> is presented
            when an activity is invoked. The value, if specified, MUST be one of
            the following (if omitted, defaults to <dfn>window</dfn>):
              <ul>
                <li><dfn id="propdef-activities-disposition-window">window</dfn>:
                The page handling the activity is opened in a new "window" (on a
                mobile device, for example, this view will replace the original
                app that requested the activity). The page MUST call
                <code>navigator.setMessageHandler</code> for each activity it
                supports and subsequently execute the activity for which it
                receives a message. Further, if the activity requires a return
                value, the page MUST call <code>activity.postResult</code> or
                <code>activity.postError</code> (where <code>activity</code> is
                the first argument provided to the function specified by
                <code>setMessageHandler</code>) as appropriate. These functions
                are specified in greater details in the WebActivities
                document.</li>

                <li><dfn id="propdef-activities-disposition-inline">inline</dfn>:
                The page handling the activity will open in an overlay (on a
                mobile device, for example, this will be rendered in a popup over
                the original app that requested the activity). Subsequent behavior
                is exactly the same as if the disposition were
                <dfn>window</dfn>.</li>
              </ul>

            <li><dfn id="propdef-activities-filters">filters</dfn>:
            <i>OPTIONAL</i>. This value is a dictionary, each property of which
            specified a particular filter. These filters will be applied while
            determining apps suitable for handling a given activity. Filter names
            are free-form text, but their values MUST be either a string or an
            array of strings (the exact type depends on the filter).</li>
          </ul>
-->
            </ul>
          </section>
        </section>

        <section>
          <h2>Serving Manifests</h2>
          <p>An <a>application manifest</a> MUST be served from the same origin as
           the application.
          </p>

          <p>When served as a static file, it is RECOMMENDED that the manifest is
          stored with the extension <code>.webapp</code>. The manifest MUST be
          served with a <i>Content-Type</i> header of
          <code>application/x-web-app-manifest+json</code>. It is RECOMMENDED that
          <a>application manifests</a> are served over SSL.
          </p>
        </section>
      </section>
      
      <section>
        <h2>System Application Origin</h2>
        <section>
          <h2>URI Scheme</h2>
          <p>A <code>app:</code> URI scheme is used to define the origin [[!ORIGIN]] of an installed web application. All <code>app:</code> URL must follow this ABNF (<a href="http://www.ietf.org/rfc/rfc5234.txt">RFC5234</a> defines ABNF):
          </p>
          <div class="block">
            <pre class="code">
              <code>
                webApplicationUri = scheme "://" uniqueId path ["?" query] ["#" fragment]
                scheme = "sysapp"
                uniqueId = *unreserved
              </code>
            </pre>
          </div>
          <p>
            Where <a href="http://tools.ietf.org/html/rfc3986#section-3.3">path</a>, <a href="http://tools.ietf.org/html/rfc3986#section-3.4">query</a>, <a href="http://tools.ietf.org/html/rfc3986#section-3.5">fragment</a>, and <a href="http://tools.ietf.org/html/rfc3986#section-2.3">unreserved</a> are defined in <a href="http://tools.ietf.org/html/rfc3986">URI</a> 
          </p>
          <p>
            When synthesizing a <code>webApplicationUri</code> string, the runtime MUST normalize it using syntax-based normalization defined in [<a href="http://tools.ietf.org/html/rfc3987">IRI</a>].
          </p>
          <p>
            The <code>uniqueId</code> is a string uniquely identifying a system application.
          </p>
          <p>
            The <code>query</code> and <code>fragment</code> components complement the path component but play no role in identifying a resource within the system application package.
          </p>
        </section>
        <section>
          <h2>Dereferencing Rules</h2>
          <p>
            The rules for dereferencing a <code>webApplicationUri</code> are as follows:
          </p>
          <p>
            <ol>
              <li>Resolve URI into an absolute URL using the <a href="http://www.w3.org/TR/html5/urls.html#resolving-urls">algorithm</a> defined in [[!HTML5]]. </li>
              <li>If the URI does not conform to the <code>webApplicationUri</code> ABNF, return an error and terminate this algorithm.</li>
              <li>If the <code>uniqueId</code> does not match the one assigned to this system application, return an error and terminate this algorithm.</li>
              <li>
                Let <var>file-entry</var> be the result of running an algorithm for finding a file within the system application package using the <code>path</code> component as the argument.
                <div class='note'>
                  An example algorithm for <a href="http://www.w3.org/TR/widgets/#rule-for-finding-a-file-within-a-widget-package-0">finding a file within a package</a> can be found in W3C <a href="http://www.w3.org/TR/widgets">Widgets</a> specification.
                </div>
              </li>
              <li>If <var>file-entry</var> is not found at the given path, return an error and terminate this algorithm.</li>
              <li>
                Let <var>content-type</var> be the result of running an algorithm for identifying the media type of a file within the system application package using the <var>file-entry</var> component as the argument.
                <div class='note'>
                  An example algorithm for <a href="http://www.w3.org/TR/widgets/#rule-for-identifying-the-media-type-of-a-file">identifying the mime type of a file within a package</a> can be found in W3C <a href="http://www.w3.org/TR/widgets">Widgets</a> specification.
                </div>
              </li>
              <li>Return <var>file-entry</var> and <var>content-type</var> to the runtime.</li>
            </ol>
          </p>
          <p> 
            The runtime MUST treat the <code>webApplicationUri</code> pointing to the system application package root directory as the local document's origin.
          </p>
          <p> 
            All DOM objects' properties that reference system application's local resources MUST use <code>webApplicationUri</code> scheme.
            <div class='note'>
              For example, if the runtime loads a system application whose unique ID is "my-unique-webapp-id", then the following Javascript statement evaluates to true:
              <pre>window.location.href=="app://my-unique-webapp-id/"</pre>
              Consequently, if this document contains an image element loaded from within the system application package, then the following statement evaluates to true:
              <pre>img.src=="app://my-unique-webapp-id/path/to/image/image_filename.png"</pre>
            </div>
          </p>
          <p>
            Any attempt to access resources from within the system application's package using URI scheme other than <code>webApplicationUri</code> MUST be blocked by the runtime. This includes, but is not limited to, attempts to access system application package with the use of <code>file://</code> scheme.
          </p>
          <p>
            When dereferencing a <code>webApplicationUri</code>, the runtime MUST make sure that the resulting <var>file-entry</var> is located within the requesting system application's package. Any attempts to break out of the package (for example by using symbolic links) MUST be blocked.
          </p>
        </section>
      </section>
      
      <section>
        <h2>Packaging</h2>
        <p>A <dfn>packaged application</dfn> is an application that is
        self-contained in a container. All resources that are commonly used by the
        application SHOULD be available in the container.
        </p>

        <p>A <dfn>hosted application</dfn> is an application that is not a
        <a>packaged application</a>
        </p>

        <section class="informative">
          <h2>Use cases</h2>
          <p>A <a>packaged application</a> would be useful in a few situations,
          amongst them:
            <ul>
              <li>If a marketplace wants to guarantee that an application is safe,
              it allows it to review the application codes and makes sure that all
              permissions granted can't be used outside of the reviewed code. In
              addition, it forces, by design, that any update will go trough the
              same review process.
              </li>
              <li>Some developers might want to develop for the Web Platform without
              investing in a server infrastructure. Any client-side only
              applications written on top of the Web Platform will be able to be
              very easily distributed that way.
              </li>
            </ul>
          </p>
        </section>

        <section>
          <h2>Package format</h2>
          <p>An <a>application manifest</a> for the application MUST be present at
          the root of the container.
          </p>

          <p>The container of a <a>packaged application</a> MUST be a ZIP file.
          </p>
        </section>

        <section>
          <h2>URI of a packaged file</h2>
          <p>A file contained in a <a>packaged application</a> MUST have an URI
          with the following rules:
            <ul>
              <li>The <code>scheme</code> of the URI MUST be <i>app</i>.
              </li>
              <li>The <code>authority</code> of the URI MUST be an identifier unique
              for each applications. That means, two files from different
              applications can't share the same <code>authority</code> but two files
              from the same application will.
              </li>
              <li>The <code>path</code> of the URI MUST be the file name.
              </li>
              <li>Any other parts of the URI MUST be empty.
              </li>
            </ul>
          </p>

          <p>For more information about URI's, refer to [[!RFC3986]].</p>

          <p>
          For example, the URI of <i>index.html</i> from an application can be:
          <i>app://e35b8412-7451-46e7-ab29-0cee24fd486a/index.html</i>.
          </p>

          <p>The URI of a packaged file is defined such as two files from the same
          <a>packaged application</a> MUST share the same origin.<br>
          A file from a <a>packaged application</a> and any other resource outside
          of this application (an application or not, packaged or not) MUST not
          share the same origin. [[!ORIGIN]]</p>
        </section>

        <section>
          <h2>Manifest</h2>

          <p>A <a>packaged application</a> MUST have a copy of its <a>application
          manifest</a> outside of the package so it can be used for installation
          and updates purposes. As a consequence, that copy of the <a>application
          manifest</a> can be reduced to only a few properties: <a>name</a>,
          <a>version</a> and <a>relNotes</a>. In addition, a new property can be
          used only in the content a packaged <a>application manifest<a>: <dfn
          id='prop-package'>package</dfn> that SHOULD contain an object with the
          following properties:
            <ul>
              <li><dfn id='prop-package-url'>url</dfn>: this property MUST contain
              the URL of the package related to that <a>application manifest</a>.
              <br>
              When installing or updating a <a>packaged application</a> from an
              <a>application manifest</a>, the UA MUST always use the manifest
              inside the package as soon as the package is found.</li>
              <li><dfn id='prop-package-size'>size</dfn>: the property SHOULD
              contain the size of the package in kylo bytes.</li>
              <li><dfn id='prop-package-sha256'>sha256</dfn>: this property SHOULD
              contain the SHA256 checksum of the package and SHOULD be used by the
              UA to verify the integrity of the downloaded package.</li>
            </ul>
          </p>

          <pre class='example highlight'>
          {
            "name": "My Packaged App",
            "description": "This is my first packaged app!",
            "launch_path": "/",
            "version": "1.0",
            "developer": {
              "name": "Mozilla",
              "url": "https://mozilla.org/en-US"
            },
            "package": {
              "url": "http://example.org/mypackagedapp.zip",
              "size": "1024",
              "sha256": "6df134b0cfd88d6d4f27a99e29b9923d50eb8b2c0d5289c60012de424c7a9d97"
            }
          }
          </pre>
        </section>

        <todo>
          * Add relNotes to the properties of the manifest, like:
          'relNotes': {
            '1.0': "This is what has been done...",
            '0.1': "That was so long ago..."
          }
        </todo>
      </section>
      
      <section class='informative'>
        <h2>Delivery</h2>
        <p>
          A system application shall be delivered in a package if the system application requires to deliver more than one file to the device at installation time. Otherwise, if the manifest file is sufficient to install the system application on the device, the system application will not be packaged.
        </p>
        <p>
          There can be multiple channels for system application delivery:
          <ul>
            <li><dfn>App store</dfn>, which will provide a trusted gateway for system application discovery and delivery.</li>
            <li><dfn>Open online distribution</dfn>, such as distribution of packages or manifests on websites.</li>
            <li><dfn>Export from Browser</dfn>, which will export and install a website as a system application via the manifest.</li>
          </ul>
        </p>
      </section>
      
      <section>
        <h2>Installation</h2>
        <p>
          The runtime MUST prompt user the list of privileges that the system applications will obtain upon installation.
        </p>
        <p>
          The runtime MUST support the processing of <a>packaging format</a> as part of system application installation procedure.
        </p>
        <p>
          The runtime MUST support the processing of <a>manifest format</a> as part of system application installation procedure.
        </p>
        <p>
          The runtime MUST support validation of digital signature(s) if the system application package contains one or more digital signature files.
        </p>
        <p>
          The runtime MUST register the system application as application service handlers if the manifest specifies one or more services.
        </p>
      </section>

      <section>
        <h2>Uninstallation</h2>
        <p>
          The runtime MUST support system application uninstallation.
        </p>
        <p>
          All of system application's private data MUST be erased during the uninstallation.
        </p>
      </section>
      
      <section>
        <h2>Update</h2>
        <p>An application SHOULD advertise an update by updating its
        <a>application manifest</a>.</p>

        <p>The UA SHOULD regularly check if the <a>application manifest</a> of
        installed applications has not been updated. To know if the file has been
        updated, HTTP semantics apply. The UA SHOULD also try to compare version
        numbers if presents to prevent false-positives.</p>

        <p>For <a>package applications</a>, both <a>application manifest</a>s
        (outside and inside the package) SHOULD be updated. However, the
        <a>application manifest</a> inside the package SHOULD always be checked to
        make sure the update (or the install) is genuine.</p>
      </section>
      
      <section>
      	<h2><code>WindowRuntime</code> interface</h2>
	      <dl title='[NoInterfaceObject] interface WindowRuntime' class='idl'>
	        <dt>readonly attribute Runtime runtime</dt>
	        <dd>
	          This attribute SHOULD be a unique instance of the <a href='#runtime-interface'><code>Runtime</code></a> interface that a user agent implements.
	        </dd>
	      </dl>
	      <dl title='Window implements WindowRuntime' class='idl'>
	      </dl>
	      <p>
	      	 <a href='http://www.w3.org/TR/html5/browsers.html#window'><code>Window</code></a> interface of the user agents implementing the <a href='#system-application'>system application</a> <a href='#runtime'>runtime</a> MUST 
	        implement <a href='#windowruntime-interface'><code>WindowRuntime</code></a> interface as the <code>runtime</code> attribute of the <code>window</code> object.
	      </p>
      </section>
      
      <section>
      	<h2><code>Runtime</code> interface</h2>
        <dl title='interface Runtime' class='idl'>
          <dt>readonly attribute DOMString name</dt>
          <dd>
            This attribute specifies the name of the <a href='#runtime'>runtime</a>.
          </dd>
          <dt>readonly attribute DOMString version</dt>
          <dd>
            This attribute specifies the version of the <a href='#runtime'>runtime</a>.
          </dd>
          <dt>readonly attribute DOMString platform</dt>
          <dd>
            This attribute specifies the platform on which the <a href='#runtime'>runtime</a> is executing.
          </dd>
          <dt>readonly attribute Application application</dt>
          <dd>
            This attribute represents the <a href='#application-interface'><code>Application</code></a> interface of the <a href='#main-browsing-context'>main browsing context</a> of the <a href='#system-application'>system application</a>.
          </dd>
        </dl>
        <div class='note'>
        	 <code>runtime</code> object MUST only be accessible from the <a href='#main-browsing-context'>main browsing context</a> of a <a href='#system-application'>system application</a>.
        </div>
        <p>
        	 To make the Runtime interface be resuable in functional level upon different requirements 
        	 of user agents, two interfaces, <a href='#runtimeinstaller-interface'><code>RuntimeInstaller</code></a> and 
        	 <a href='#runtimeexecutionmanager-interface'><code>RuntimeExecutionManager</code></a>, are separately defined.
        </p>
        <dl title='Runtime implements RuntimeInstaller' class='idl'>
	      </dl>
	      <p>
	      	 <a href='#runtime-interface'><code>Runtime</code></a> interface of the user agents implementing the <a href='#system-application'>system application</a> 
	      	 <a href='#runtime'>runtime</a> MAY implement <a href='#runtimeinstaller-interface'><code>RuntimeInstaller</code></a> interface to provide install, update 
	      	 and uninstall capabilities of the <a href='#system-application'>system applications</a>.
	      </p>
	      <dl title='Runtime implements RuntimeExecutionManager' class='idl'>
	      </dl>
	      <p>
	      	 <a href='#runtime-interface'><code>Runtime</code></a> interface of the user agents implementing the <a href='#system-application'>system application</a> 
	      	 <a href='#runtime'>runtime</a> MUST implement <a href='#runtimeexecutionmanager-interface'><code>RuntimeExecutionManager</code></a> interface to provide launch, 
	      	 pause, resume and terminate capabilities of the <a href='#system-application'>system applications</a>.
	      </p>
      </section>
      
      <section>
        <h2><code>RuntimeInstaller</code> interface</h2>
        <dl title='interface RuntimeInstaller' class='idl'>
          <dt>DOMRequest install (in DOMString manifestUrl, Object? parameters)</dt>
          <dd>
            This method MUST return a <a href='http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html#domrequest-interface'><code>DOMRequest</code></a> object and install application asynchronously.
          </dd>
          <dt>DOMRequest uninstall (in DOMString applicationId)</dt>
          <dd>
            This method MUST return a <a href='http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html#domrequest-interface'><code>DOMRequest</code></a> object and uninstall application asynchronously.
          </dd>
          <dt>DOMRequest update (in DOMString applicationId)</dt>
          <dd>
            This method MUST return a <a href='http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html#domrequest-interface'><code>DOMRequest</code></a> object and update the application asynchronously.
          </dd>
          <dt>attribute EventHandler oninstall</dt>
          <dd>
            This <code>EventHandler</code> attribute is invoked when <code>install</code> event is fired by the runtime.
          </dd>
          <dt>attribute EventHandler onuninstall</dt>
          <dd>
            This <code>EventHandler</code> attribute is invoked when <code>uninstall</code> event is fired by the runtime.
          </dd>
          <dt>attribute EventHandler onupdate</dt>
          <dd>
            This <code>EventHandler</code> attribute is invoked when <code>update</code> event is fired by the runtime.
          </dd>
        </dl>
      </section>
      
      <section>
      	<h2><code>Application</code> interface</h2>
	      <dl title='interface Application : EventTarget' class='idl'>
	        <dt>readonly attribute DOMString id</dt>
	        <dd>
	          This attribute specifies the unique ID of the <a href='#system-application'>system application</a>.
	        </dd>
	        <dt>readonly attribute DOMString name</dt>
	        <dd>
	          This attribute specifies the name of the <a href='#system-application'>system application</a>.
	        </dd>
	        <dt>readonly attribute DOMString description</dt>
	        <dd>
	          This attribute specifies the description of the <a href='#system-application'>system application</a>.
	        </dd>
	        <dt>readonly attribute DOMString version</dt>
	        <dd>
	          This attribute specifies the version of the <a href='#system-application'>system application</a>.
	        </dd>
	        <dt>readonly attribute Date installDate</dt>
	        <dd>
	          This attribute specifies the installation date of the <a href='#system-application'>system application</a>n.
	        </dd>
	        <dt>readonly attribute Date updateDate</dt>
	        <dd>
	          This attribute specifies the update date of the <a href='#system-application'>system application</a>.
	        </dd>
	        <dt>readonly attribute unsigned long size</dt>
	        <dd>
	          This attribute specifies the size of the <a href='#system-application'>system application</a>.
	        </dd>
	        <dt>readonly attribute DOMString manifestUrl</dt>
	        <dd>
	          This attribute specifies the manifest url of the <a href='#system-application'>system application</a> from which addtional application information can be referred to.
	        </dd>
	        <dt>readonly attribute boolean show</dt>
	        <dd>
	          This attribute returns boolean value to indicate whether the application is visible.
	        </dd>
	        <dt>void exit ()</dt>
	        <dd>
	          This method MUST terminate the <a href='#system-application'>system application</a> itself.
	        </dd>
	        <dt>void hide ()</dt>
	        <dd>
	          This method MUST hide the <a href='#system-application'>system application</a> itself in background.
	        </dd>
	        <dt>attribute EventHandler onlaunch</dt>
	        <dd>
	          This <code>EventHandler</code> attribute is invoked when <code>launch</code> event is fired by the <a href='#runtime'>runtime</a>.
	        </dd>
	        <dt>attribute EventHandler onterminate</dt>
	        <dd>
	          This <code>EventHandler</code> attribute is invoked when <code>terminate</code> event is fired by the <a href='#runtime'>runtime</a>.
	        </dd>
	        <dt>attribute EventHandler onpause</dt>
	        <dd>
	          This <code>EventHandler</code> attribute is invoked when <code>pause</code> event is fired by the <a href='#runtime'>runtime</a>.
	        </dd>
	        <dt>attribute EventHandler onresume</dt>
	        <dd>
	          This <code>EventHandler</code> attribute is invoked when <code>resume</code> event is fired by the <a href='#runtime'>runtime</a>.
	        </dd>
            <dt>attribute EventHandler onrequest</dt>
	        <dd>
	          This <code>EventHandler</code> attribute is invoked when <code>request</code> event is fired by the <a href='#runtime'>runtime</a>.
	        </dd>
        </dl>
      </section>  
        
      <div class='note'>
        <a href='#application-interface'><code>Application</code></a> interface has been inherited from <a href='http://dvcs.w3.org/hg/domcore/raw-file/tip/Overview.html#eventtarget'><code>EventTarget</code></a> interface such that 
        the <a href='#application-interface'><code>Application</code></a> object can add relevant event handlers to monitor system 
        generated events, e.g. "lowbattery", etc., as well as application lifecycle events.
      </div>
    </section>

    <section>
      <h2>Runtime Browsing Context</h2>
      <p>
        <a href='#system-application'>System application</a>s MAY consist of multiple <a href='http://www.w3.org/TR/html5/browsers.html#windows'>browsing context</a>s:
      </p>
      <ul>
        <li><dfn id='main-browsing-context'>Main <a href='http://www.w3.org/TR/html5/browsers.html#windows'>browsing context</a></dfn> [[!HTML5]] (created by <a href='#runtime'>runtime</a>)</li>
        <p>
        	 <a href='#main-browsing-context'>Main browsing context<a> is the default top level 
        	 browsing context that MUST be created by <a href='#runtime'>runtime</a> through three 
        	 possible routes: user interaction (e.g. touch application icon in device idle screen), 
        	 script execution (e.g. application launch() function) or service request by other 
        	 system applications.
        </p>
        <li><a href='http://www.w3.org/TR/html5/browsers.html#auxiliary-browsing-context'><dfn id='auxiliary'>Auxiliary browsing context</dfn></a> [[!HTML5]] (created by window.open)</li>
        <p>
        	 Auxiliary browsing context is allowed to be opened by the browsing contexts that consist of the system application.
        </p>
        <li><a href='http://www.w3.org/TR/html5/browsers.html#nested-browsing-contexts'><dfn id='nested'>Nested browsing context</dfn></a> [[!HTML5]] (created by iframe)</li>
        <p>
        	 Nested browsing context is allowed to be inserted in the top browsing contexts that consist of the system application.
        </p>
      </ul>
      <p>
      	<a href='#runtime'>Runtime</a> provides runtime browsing context in which system 
        application executes throughout its lifecycle. Basically, system application runtime 
        context exactly conforms to the model of browsing context defined in HTML5 specification. 
        (All the terminologies and the corresponding definitions from HTML5 specification 
        [[!HTML5]] are used in this proposal.)
      </p>
      <p>
        A system application is composed of at least one browsing context. A default top browsing 
        context, called <a href='#main-browsing-context'>main browsing context</a>, MUST be created by the runtime when a system 
        application is launched. A system application MAY have only a single <a href='#main-browsing-context'>main browsing context</a> 
        which represents the system application's main runtime context. A system application MAY 
        have nested browsing contexts as well as auxiliary browsing contexts.
      </p>
      <div class="note">
        A significant difference comes in the security policy: the nested browsing context and 
        auxiliary browsing context are isolated within their own separate sandboxes.
      </div>
      <p>
      	 The <a href='runtime'>runtime</a> MUST fire system application's lifecycle events and relevant system defined 
      	 events only to the <a href='#main-browsing-context'>main browsing context</a>. The nested browsing contexts and auxiliary 
      	 browsing context SHOULD NOT catch the lifecycle events and runtime system events.
      </p>
      <p>
      	 Each browsing context of a system application MAY receive its own DOM events as normal 
      	 web browsing context's active Document object does. 
      </p>
    </section>
      
    <section>
      <h2>Execution Model</h2>
      <section>
        <h2>Execution Lifecycle: States and Events</h2>
        <p>
          A system application SHALL be in one of following application states during its execution lifecycle:
          <ul>
            <li><code>Running</code></li>
            <li><code>Paused</code></li>
            <li><code>Terminated</code></li>
          </ul>
        </p>
        <p>
          <code>Running</code> state indicates that the system application instance is ready. The main browsing context is initialized, the application logic can be executed, and application/system events can be handled by the system application. A system application SHOULD immediately enter the <code>running</code> state as soon as the launching finishes. 
        </p>
        <p><code>Paused</code> state indicates that the system application is suspended and cannot handle any events. </p>
        <p><code>Terminated</code> state indicates that the system application instance is destroyed. </p>
        <p>
          The runtime MUST support triggering of following application events:
          <ul>
            <li><code>launch</code></li>
            <li><code>request</code></li>
            <li><code>pause</code></li>
            <li><code>resume</code></li>
            <li><code>terminate</code></li>
          </ul>  
        </p>
        <p>
          <code>launch</code> event MUST be triggered immediately after the system application transits from <code>terminated</code> state to <code>running</code> state. 
          <div class='note'>
            It's important to note that <code>launch</code> event is triggered even before <code>document</code> events such as <code>DOMContentLoaded</code>, <code>onLoad</code>.
          </div>
          <div class='issue'>
            What will be the real world usage for <code>launch</code> event? 
          </div>
        </p>
        <p>
          <code>request</code> event MUST be triggered when the system application is in <code>running</code> state. 
        </p>
        <p>
          <code>request</code> event MUST NOT be triggered before the <code>launch</code> event.
        </p>
        <p>
          <code>pause</code> event MUST be triggered immediately before the system application transits from <code>running</code> state to <code>paused</code> state.
        </p>
        <p>
          <code>resume</code> event MUST be triggered immediately after the system application transits from <code>paused</code> state to <code>running</code> state.
        </p>
        <p>
          <code>terminate</code> event MUST be triggered immediately before the system application transits from <code>running</code> state to <code>terminated</code> state.
        </p>
      </section>
      <section>
        <h2>Launching</h2>
        <p>
          <dfn>Algorithm for launching a system application</dfn>:
          <ol>
            <li>If the system application is in <code>terminated</code> state:</li>
            <ol type='A'>
              <li>Initialize the system application instance and main browing context.</li>
              <li>Load the startup page in main browsing context.</li>
              <li>Trigger <code>launch</code> event on main browsing context.</li>
            </ol>
            <li>Else, if the system application is in <code>paused</code> state:</li>
            <ol type='A'>
              <li>Resume the system application.</li>
              <li>Bring the main browsing context to the top of window stack.</li>
              <li>Bring the system application to foreground.</li>
              <li>Trigger <code>resume</code> event on the main browsing context.</li>
            </ol>
            <li>Else, if the system application is in background and in <code>running</code> state:</li>
            <ol type='A'>
              <li>Bring the system application to foreground.</li>
            </ol>
          </ol>
        </p>
        <p>
          <dfn>Algorithm for launching a system application with service request</dfn>:
          <ol>
            <li>If the system application is in <code>terminated</code> state:</li>
            <ol type='A'>
              <li>Initialize the system application instance and main browing context.</li>
              <li>Load the startup page in main browsing context.</li>
              <li>Trigger <code>launch</code> event on main browsing context.</li>
              <li>Trigger <code>request</code> event on main browsing context (with the request data).</li>
              <div class='note'>
                The runtime MUST ensure that the <code>request</code> event handler is called after the system application registers the handler via <code>window.runtime.application.onrequest = function(){};</code>
              </div>
            </ol>
            <li>Else, if the system application is in <code>paused</code> state:</li>
            <ol type='A'>
              <li>Resume the system application.</li>
              <li>Bring the main browsing context to the top of window stack.</li>
              <li>Bring the system application to foreground.</li>
              <li>Trigger <code>resume</code> event on main browsing context.</li>
              <li>Trigger <code>request</code> event on main browsing context.</li>
            </ol>
            <li>Else, if the system application is in background and in <code>running</code> state:</li>
            <ol type='A'>
              <li>Bring the main browsing context to the top of window stack.</li>
              <li>Bring the system application to foreground.</li>
              <li>Trigger <code>request</code> event on main browsing context.</li>
            </ol>
          </ol>
        </p>

      </section>
      <section>
        <h2>Service Request Handling</h2>
        <p>
          <dfn>Algorithm for handling a service request</dfn>:
          <ol>
            <li>If the system application is in <code>terminated</code> state:</li>
            <ol type='A'>
              <li>Initialize the system application instance and main browing context.</li>
              <li>Load the service page in main browsing context.</li>
              <li>Trigger <code>launch</code> event on main browsing context.</li>
              <li>Trigger <code>request</code> event on main browsing context (with the request data).</li>
              <div class='note'>
                The runtime MUST ensure that the <code>request</code> event handler is called after the system application registers the handler via <code>window.runtime.application.onrequest = function(){};</code>
              </div>
            </ol>  
            <li>Else, if the system application is in background and in <code>paused</code> state:</li>
            <ol type='A'>
              <li>Resume the system application.</li>
              <li>Trigger <code>resume</code> event on main browsing context.</li>
              <li>If the service page is already created:</li>
              <ol type='a'>
                <li>Bring the main browsing context to the top of window stack.</li>
                <li>Bring the system application to foreground.</li>
                <li>Trigger <code>request</code> event on main browsing context.</li>
              </ol>
              <li>Else, (if the service page is not created yet): </li>
              <ol type='a'>
                <li>Load the service page in main browsing context.</li>
                <div class='issue'>
                  We probably need an event to allow the application to save current main browsing context before it's get replaced by the new service page browsing context. Can <code>unload</code> event be used for this purpose?
                </div>
                <li>Bring the main browsing context to the top of window stack.</li>
                <li>Bring the system application to foreground.</li>
                <li>Trigger <code>request</code> event on main browsing context.</li>
              </ol>
            </ol>          
            <li>Else, if the system application is in background and in <code>running</code> state:</li>
            <ol type='A'>
              <li>If the service page is already created:</li>
              <ol type='a'>
                <li>Bring the main browsing context to the top of window stack.</li>
                <li>Bring the system application to foreground.</li>
                <li>Trigger <code>request</code> event on main browsing context.</li>
              </ol>
              <li>Else, (if the service page is not created yet): </li>
              <ol type='a'>
                <li>Load the service page in main browsing context.</li>
                <li>Bring the main browsing context to the top of window stack.</li>
                <li>Bring the system application to foreground.</li>
                <li>Trigger <code>request</code> event on main browsing context.</li>
              </ol>
            </ol>
            <li>Else, </li>
            <ol type='A'>
              <li>If the service page is already created:</li>
              <ol type='a'>
                <li>Bring the main browsing context to the top of window stack.</li>
                <li>Trigger <code>request</code> event on main browsing context.</li>
              </ol>
              <li>Else, (if the service page is not created yet): </li>
              <ol type='a'>
                <li>Load the service page in main browsing context.</li>
                <li>Bring the main browsing context to the top of window stack.</li>
                <li>Trigger <code>request</code> event on main browsing context.</li>
              </ol>
            </ol>            
          </ol>
        </p>
      </section>
      <section>
        <h2>Pause and Resume</h2>
        <p>
          <dfn>Algorithm for pausing a system application</dfn>:
        </p>
        <p>
          If the system application is in <code>running</code> state: 
          <ol>
            <li>Trigger <code>pause</code> event on main browsing context.</li>
            <li>Pause the system application.</li>
          </ol>
        </p>
        <p>
          <dfn>Algorithm for resuming a system application</dfn>:
        </p>
        <p>
          If the system application is in <code>paused</code> state: 
          <ol>
            <li>Resume the system application.</li>
            <li>Trigger <code>resume</code> event on main browsing context.</li>
          </ol>
        </p>
      </section>

      <section>
        <h2>Terminate</h2>
        <p>
          <dfn>Algorithm for terminating a system application</dfn>:
          <ol>
            <li>If the system application is in <code>running</code> state:</li>
            <ol type='A'>
              <li>Trigger <code>terminate</code> event on main browsing context.</li>
              <li>Close the main browsing context.</li>
              <li>Close the system application.</li>
            </ol>
            <li>Else, if the system application is in <code>paused</code> state:</li>
            <ol type='A'>
              <li>Close the main browsing context.</li>
              <li>Close the system application.</li>
            </ol>
          </ol>
        </p>
      </section>
      
      <section>
        <h2>Consequences of visibility</h2>

        <p>While an application is running, it can be part or fully hidden. The
        visibility events described in [[!PAGE-VISIBILITY]] MUST be sent when
        the visibility status of the application changes.</p>

        <p>In addition, when the application becomes fully hidden, the UA MAY
        put the application in a <dfn>pause state</dfn>. That means all script
        SHOULD stop running, such as rendering, parsing, processing media files,
        any action that requires CPU and memory or would distract the user.</p>
      </section>
      
      <section>
        <h2><code>RuntimeExecutionManager</code> interface</h2>
        <dl title='interface RuntimeExecutionManager' class='idl'>
          <dt>DOMRequest launch (in DOMString applicationId)</dt>
          <dd>
            This method MUST return a <a href='http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html#domrequest-interface'><code>DOMRequest</code></a> object and launch the designated <a href='#system-application'>system application</a> asynchronously.
          </dd>
          <dt>DOMRequest terminate (in DOMString applicationId)</dt>
          <dd>
            This method MUST return a <a href='http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html#domrequest-interface'><code>DOMRequest</code></a> object and terminate the designated <a href='#system-application'>system application</a> asynchronously.
          </dd>
          <dt>DOMRequest pause (in DOMString applicationId)</dt>
          <dd>
            This method MUST return a <a href='http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html#domrequest-interface'><code>DOMRequest</code></a> object and pause the designated <a href='#system-application'>system application</a> asynchronously.
          </dd>
          <dt>DOMRequest resume (in DOMString applicationId)</dt>
          <dd>
            This method MUST return a <a href='http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html#domrequest-interface'><code>DOMRequest</code></a> object and resume the designated <a href='#system-application'>system application</a> asynchronously.
          </dd>
          <dt>DOMRequest getApplications (in ApplicationState state, applicationListCallback? callback)</dt>
          <dd>
            This method MUST return a <a href='http://mounirlamouri.github.com/sysapps/proposals/RunTime-Security/Overview.html#domrequest-interface'><code>DOMRequest</code></a> object and get the list of <a href='#system-application'>system application</a>s 
            asynchronously. The <code>state</code> parameter passes to the <a href='#runtime'>runtime</a> the state of the 
            <a href='#system-application'>system application</a>s to look up.
          </dd>
        </dl>
      </section>
      
      <section>
      	 <h2>enum <code>ApplicationState</code></h2>
        <dl id='enum-basic' class='idl' title='enum ApplicationState'>
          <dt>installed</dt>
          <dd>The system application is in installed state.</dd>
          <dt>running</dt>
          <dd>The system application is in running state.</dd>
          <dt>paused</dt>
          <dd>The system application is in paused state.</dd>
        </dl>
      </section>
       
      <section>
        <h2><code>applicationListCallback</code> callback</h2>
        <dl id='cb-less-basic' class='idl' title='callback applicationListCallback = void'>
          <dt>optional Application[] applications</dt>
          <dd>array of <a href='#application-interface'><code>Application</code></a> objects</dd>
        </dl>
      </section>
    </section>

    <section>
      <h2>Security Model</h2>
      <section>
        <h2>Trusted applications</h2>

        <section class="informative">
          <h2>Use cases</h2>

          <p>Any application can be compromised. It just depends on how much
          effort the attacker wants to provide and how much efforts the author
          wants to dedicate making its application more secure. With an
          interesting enough outcome, attackers could easily double their
          efforts to beat the security in place. For example, an API allowing to
          send SMS, if it can be manipulated by the evil persons, could be used
          to send premium SMS and steal money from the users.</p>

          <p>With a simple permission system, users could be tricked to install
          the application and accept to grant the application the relevant
          permissions. These kind of attacks are proven to be efficient.</p>
        </section>

        <section>
          <h2>Chain of trust</h2>

          <p>An application is said to be a <dfn>trusted application</dfn> if
          the origin installing the application is trusted by the UA and the
          origin installing the application consider the application as
          trusty.</p>

          <p>A UA SHOULD have the public key of all installation origin it is
          considering trusted.</p>
        </section>

        <section>
          <h2>Marking an application trusted</h2>

          <p>A <a>hosted application</a> MUST be recognized as marked trusted by
          the installation origin if the <a>application manifest</a> is signed
          by the installation origin's private key.</p>

          <p>A <a>packaged application</a> MUST be recognized as marked trusted
          by the installation origin if the package is signed by the
          installation origin's private key.</a>

          <p>In both cases, the application SHOULD be considered as trusted by
          the UA if the UA considers the installation origin as trusted,
          following the chain of trust mentioned above.</p>
        </section>

        <section class="informative">
          <h2>Security considerations</h2>

          <p>UA should keep in mind that a signed package is way more secure
          than a signed manifest. A correctly signed package can only be
          compromised if the private key has been compromised or the
          cryptographic algorithm. A UA should not trust an installation origin
          if it does not trust its ability to keep safe its private key.</p>

          <p>On the other hands, a signed manifest only proves that the
          application is genuinly trusted (if the private key was not
          compromised nor the cryptographic algorithm). Anything else can be
          compromised given that it lives in the Internet. There is no need to
          list all possible attacks.</p>

          <p>An important difference between a <a>packaged application</a> and a
          <a>hosted application</a> is the ability to review the code. Any
          permission granted to a <a>packaged application</a> will be granted to
          the code inside the package only. That means trusting such application
          is way easier after a code review, for example.</p>

          <p>However, code review for <a>packaged application</a>s could be
          avoided if the installation origin trusts enough an application
          developer. Such developer could get all its <a>packaged
          application</a>s trusted without too much risk for the users.<br>
          The same thing colud be done for <a>hosted application</a> except that
          it would be recommended to make sure that the developer has strong
          server security or would not risk any security flaw on their servers.
          </p>
        </section>
      </section>
      <section>
        <h2>Browsing Context Trust Model</h2>
        <p>
          A browsing context is <a>untrusted</a> if the browsing context is created from a remote URL or from a local file of an <a>untrusted</a> system application.
        </p>
        <p>
          A browsing context is <a>trusted</a> if the browsing context is created from a local file of a <a>trusted</a> system application.
        </p>
        <p>
          A browsing context is <a>privileged</a> if the browsing context is created from a local file of a <a>privileged</a> system application.
        </p>
        <section>
          <h2>Navigation</h2>

          <p>Depending on the user interface around the application context,
          navigating outside the application's origin might lock the user out of the
          application. To prevent that, the UA SHOULD NOT allow navigation out of
          the application's origin, unless the origin is specified in the following
          <a>application manifest</a> property:
            <ul>
              <li><dfn id='prop-allow-navigation'>allow-navigation</dfn>: the property
              SHOULD contain an array of origins that can be navigated to from the
              application.</li>
            </ul>
          </p>

          <p>If the application tries to navigate to an unauthorized origin, the UA
          SHOULD open the link in a regular but distinct browsing context.
          </p>
        </section>
      </section>

      <section>
      	<h2>Content and Network Security</h2>
        <p>
        	 The runtime MUST ensure csp policies specified in manifest for every system application pages.
        </p>
        <section>
          <h2>CSP Policy</h2>

          <section class="note">
            The following sub-section assumes that a <a>trusted application</a>
            can only be a <a>packaged application</a>. This needs to be updated.
          </section>

          <p>The following CSP policy MUST apply to all <a>trusted
          application</a>s [[!CSP]]:<br></p>

          <p><code>default-src *; script-src 'self'; object-src 'none';
          style-src 'self'</code></p>

          <p>This puts the following restrictions on web pages part of a
          <a>trusted application</a>:
          <ul>
            <li>Scripts can only be loaded from the package;</li>
            <li>Scripts can not use data:-URIs;</li>
            <li>Inline scripts can not be used;</li>
            <li>eval() can not be used. Neither can eval-like functions like
            setTimeout or "new Function". setTimeout can still be used as long
            as the first argument is a Function object rather than a string;<il>
            <li>onXXX attributes can't be used in the markup of pages. However,
            using the associated <a>EventHandler</a> is doable. For example:
            myElement.onXXX = someFunction;<li>
            <li>&lt;object&gt;, &lt;embed&gt; and &lt;applet&gt; are fully
            disabled. In other words, plugins won't work at all. Including
            flash.</li>
            <li>CSS can only be loaded from the package. Inline CSS is
            however allowed.</li>
          </ul></p>

          <p>This does not restrict any of the following:
          <ul>
            <li>&lt;iframe&gt;s can still point to any URL;</li>
            <li>Images can still be loaded from anywhere. Including when loaded
            using an &lt;img&gt; element, when using CSS background images or
            when using other types of CSS images;</li>
            <li>Media (audio and video) can still be loaded from anywhere;</li>
            <li>Network connections can still be opened anywhere using
            data-centric APIs like XMLHttpRequest or WebSocket.</li>
          </ul></p>

          <p>There is no way for <a>trusted application</a>s to relax this
          policy.</p>
        </section>
        <div class='issue'>
        	 How to resolve the conflicts between manifest csp and http header csp?
        </div>
        <div class='issue'>
        	 Can the runtime relax the same origin policy for cross origin requests if the following conditions are met?
        	 <ul>
        	 	 <li>Relevant CSP directives are enforced; connect-src, etc.</li>
        	 	 <li>Basically all the system applications running in the runtime are sandboxed.</li>
        	 	 <li>The system application is authenticated in a secure route. (signature, store audit process, etc.)</li>
        	 </ul>
        </div>
        <p>
        	 The runtime MUST support iframe sandbox attribute.
        </p>
        <p>
        	 The runtime MUST support CORS specification.
        </p>
      </section>
      
      <section>
        <h2>Permissions</h2>
        <section class="informative">
          <h2>Use cases</h2>

          <p>Some API might allow the application to access sensitive parts of the
          hardware or sensitive information. To prevent applications to access
          them, some APIs might require one or more permissions. For example, for
          an application to be allowed to access your geolocation information, it
          has to be granted the <i>geolocation</i> permission.</p>
        </section>

        <section>
          <h2>Permission declaration</h2>

          <p>An application SHOULD define all permissions it is going to use in
          the <a>application manifest</a>. The UA MAY automatically grant some
          permissions at install-time or ask the user to grant some applications.
          However, MAY, in addition or alternatively, ask the user to grant
          permissions at run-time.</p>

          <p>The user MUST be able to revoke a granted permission or grant a
          denied permission at any time.</p>
        </section>

        <section>
          <h2>Basic Permissions</h2>

          <p>Specifications are expected to declare the permissions they will
          require for their feature to work. Altough, some basic permissions can't
          really go into a specific specification or a related to specifications
          that might be harder to change.</p>

          <p>Thus, this specification is defining the following permissions:</p>

          <table>
            <tr>
              <th>Permission Name</th>
              <th>Permission Description</th>
              <th>Access Type</th>
            </tr>
            <tr>
              <td><code>backgroundservice</code></td>
              <td>Allow a web application to run in the background and perform
              tasks like syncing or respond to incoming messages.</td>
              <td>N/A</td>
            </tr>
            <tr>
              <td><code>desktop-notification</code></td>
              <td>Allow the application to use the Desktop Notification API.</td>
              <td>N/A</td>
            </tr>
            <tr>
              <td><code>geolocation</code></td>
              <td>Allow the application to access the Geolocation API.</td>
              <td>N/A</td>
            </tr>
            <tr>
              <td><code>storage</code></td>
              <td>Allow localStorage and IndexedDB without size limitations.</td>
              <td>N/A</td>
            </tr>
            <tr>
              <td><code>webapps-manage</code></td>
              <td>Allow access to the <code>navigator.apps.management</code> API
              to manage installed webapps.</td>
              <td>N/A</td>
            </tr>
          </table>
        </section>
      </section>
      
      <section>
      	<h2>Private Storage and Data isolation</h2>
        <p>
        	 The runtime MUST protect access of HTML5 storage (web storage, file/db storage, etc.) from different origins. 
        </p>
        <p>
          The runtime MUST NOT share the cookie database among different origins.
        </p>
        <p>In the context of a running application, all usual rules for data
        isolation MUST apply: same-origin policy, same-domain policy, or whatever
        is used. However, between two applications, those rules no longer apply.
        Two applications MUST be fully isolated from each other in the sense that
        they SHOULD NOT be able to access data from each other. For example, if
        App1 accesses <i>http://example.org</i> and gets a cookie from it, App2
        should not be able to see that cookie when accessing
        <i>http://example.org</i> even if the usual cookie sharing policy should
        allow this to happen.</p>

        <p>This isolation SHOULD apply for all data storage like <i>cookies</i>,
        <i>localStorage</i>, <i>IndexedDB</i>, <i>app cache</i> and any other Web
        Platform mechanism that allows to store data and doesn't explicitly opts
        out from the application data isolation.<br>
        The isolation SHOULD also apply to UA specifics data storage. For example,
        any permission granted or denied to a host/origin/domain should be
        isolated per-application or auto-fill and autocompletion features for
        forms.</p>
      </section>
    </section> 
    
    <section class="appendix">
      <h2><a>DOMRequest</a> interface</h2>

      <section class="note">
        <p>The <a>DOMRequest</a> interface is temporarily hosted by this
          specification. The <i>Runtime and Security Model for Web Applications
          </i> specificaton doesn't plan to keep that guest for ever, this is
          why it is currently staying in an appendix.</p>
      </section>

      <section class="informative">
        <h2>Use cases</h2>

        <p>Some methods want to return a value or do an action but can't do it
        synchronously, most of the time for performance reasons. In that case,
        most of those methods will use a callback mechanism to inform the caller
        of the success or the failure of the action.<br>
        However, this callback mechanism makes the code barely readable and
        there is no common pattern used by all API in the Web Platform.<br>
        <a>DOMRequest</a> intend to be used instead of those callbacks to make
        those APIs more developer-friendly and help code readability.</p>
      </section>

      <section>
        <h2>Definition</h2>

        <p>The <a>DOMRequest</a> interface is intented to be used by
        asynchronous methods that want to return something after performing an
        action or simply want to inform the caller that the action is done.<br>
        It returned request can also be used to inform that an error happened
        during the operation.</p>

        <p><a>A <a>DOMRequest</a> has three state. It is whether
        <code>pending</code>, <code>success</code> or <code>error</code>.<br>
        The initial state of a <a>DOMRequest</a> MUST be <code>pending</code>.
        <br>
        If a <a>DOMRequest</a> receives a <a>success message</a> while in the
        <code>pending</code> state, its state MUST change to
        <code>success</code> and SHOULD NOT change afterward.<br>
        If a <a>DOMRequest</a> receives an <a>error message</a> while in the
        <code>pending</code> state, its state MUST change to <code>error</code>
        and SHOULD NOT change afterward.<br>
        If a <a>DOMRequest</a> receives a <a>success message</a> or an
        <a>error message</a> while not in the <code>pending</code> state, the
        message MUST be ignored.</p>

        <p>A <dfn>success message</dfn> SHOULD be sent to the <a>DOMRequest</a>
        when the operation is successfuly terminated. The message MAY contain a
        value which MUST be used by the <code>result</code> attribute. If the
        message does not contain a value, <i>null</i> MUST be used instead.</p>

        <p>As soon as a <a>success message</a> is received,
        <code>readyState</code> MUST return <code>done</code>,
        <code>result</code> MUST return the received value or <i>null</i> as
        explained above and the object MUST NOT change its state and MUST,
        therefore, ignore all following <a>success message</a> and
        <a>error message</a>.<br>
        Finally, the UA MUST <a>fire a simple event</a> named
        <code>success</code> on the object</p>

        <p>An <dfn>error message</dfn> SHOULD be sent to the <a>DOMRequest</a>
        when the operation has failed. The message MAY contain a value which
        MUST be a <a>DOMError</a> object and MUST be used by the
        <code>error</code> attribute. If the message does not contain a value,
        the UA SHOULD find the most appropriate <a>DOMError</a> that represents
        the failure.</p>

        <p>As soon as an <a>error message</a> is received,
        <code>readyState</code> MUST return <code>done</code>,
        <code>error</code> MUST return the received value the most appropriate
        error value as explained above and the object MUST NOT change its state
        and MUST, therefore, ignore all following <a>success message</a> and
        <a>error message</a>.<br>
        Finally, the UA MUST <a>fire a simple event</a> named <code>error</code>
        on the object.</p>

        <section>
        <dl title='interface DOMRequest : EventTarget' class='idl'>
          <dt>readonly attribute DOMString readyState</dt>
          <dd>The attribute MUST return <code>pending</code> if the current
          state is <code>pending</code>. Otherwise, it MUST return
          <code>done</code>.</dd>

          <dt>readonly attribute any result</dt>
          <dd>The attribute MUST return <code>undefined</code> if the current
          state is not <code>success</code>. Otherwise, it MUST return the value
          provided by the <a>success message</a> or <code>null</code> if no
          value was sent with the message.</dd>

          <dt>readonly attribute DOMError? error</dt>
          <dd>The attribute MUST return <i>null</i> if the current state is not
          <code>error</code>. Otherwise, it MUST return the value provided by
          by the <a>error message</a>. If there was no provided value, it SHOULD
          return the most appropriate <a>DOMError</a> that represents the
          failure.</dd>

          <dt>[TreatNonCallableAsNull] attribute EventHandler onsuccess</dt>
          <dd></dd>

          <dt>[TreatNonCallableAsNull] attribute EventHandler onerror</dt>
          <dd></dd>
        </dl>
        </section>

        <section>
          <h2>Events</h2>

          <p>
            The following are the <a>event handlers</a> (and their corresponding
            <a>event handler event types</a>) that MUST be supported as
            attributes by the <code>DOMRequest</code> objects:
          </p>

          <table class="simple">
            <thead>
              <tr>
                <th>event handler</th>
                <th>event handler event type</th>
              </tr>
            </thead>
            <tbody>
              <tr>
                <td><strong><code>onerror</code></strong></td>
                <td><code>error</code></td>
              </tr>
              <tr>
                <td><strong><code>onsuccess</code></strong></td>
                <td><code>success</code></td>
              </tr>
            </tbody>
          </table>
        </section>

      </section>
    </section>

    <section class="appendix">
      <h2>Acknowledgments</h2>

      <p>Special thanks to Anant Narayanan for his <i>Web Application Manifest
      Format and Management APIs</i> that this specification reuse shamlesly.</p>
      <p>Special thanks to Jonas Sicking for being awesome, as always.</p>
    </section>
  </body>
</html>